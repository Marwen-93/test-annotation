import { Component, ElementRef, EventEmitter, Input, Output } from '@angular/core';
import { Annotation } from '../../models/annotation.model';
export class NgxAnnotateTextComponent {
    constructor(elementRef) {
        this.elementRef = elementRef;
        /** Represents the parts of the given text which shall be annotated. */
        this.annotations = [];
        /**
         * Determines whether annotations shall have a small button in the top right corner so that the user can
         * remove an annotation.
         */
        this.removable = true;
        /** Emits the list of existing annotations after an element has been removed. */
        this.annotationsChange = new EventEmitter();
        /** @internal */
        this.tokens = [];
        this.annotationStartingIndices = new Map();
    }
    ngOnInit() {
        this.splitTextIntoTokens();
    }
    ngOnChanges(changes) {
        if ('annotations' in changes || 'text' in changes) {
            this.splitTextIntoTokens();
        }
    }
    /**
     * Returns the start index and end index of the currently selected text range. Returns `undefined`
     * if no text is currently selected.
     */
    getCurrentTextSelection() {
        this.updateTextSelection();
        if (this.selectionStart === undefined || this.selectionEnd === undefined || this.selectionStart >= this.selectionEnd) {
            return undefined;
        }
        return {
            startIndex: this.selectionStart,
            endIndex: this.selectionEnd,
        };
    }
    /** @internal */
    isAnnotation(annotation) {
        return annotation instanceof Annotation;
    }
    /** @internal */
    onRemoveAnnotation(annotation) {
        this.annotations = this.annotations.filter(a => a !== annotation);
        this.annotationsChange.emit(this.annotations);
        this.splitTextIntoTokens();
    }
    updateTextSelection() {
        if (window.getSelection && window.getSelection().rangeCount > 0) {
            const range = window.getSelection().getRangeAt(0);
            const preSelectionRange = range.cloneRange();
            preSelectionRange.selectNodeContents(this.elementRef.nativeElement);
            preSelectionRange.setEnd(range.startContainer, range.startOffset);
            this.selectionStart = [...preSelectionRange.toString()].length;
            this.selectionEnd = this.selectionStart + [...range.toString()].length;
        }
        else {
            this.selectionStart = undefined;
            this.selectionEnd = undefined;
        }
    }
    splitTextIntoTokens() {
        this.tokens = [];
        this.annotationStartingIndices = new Map();
        // Creates a map which contains the starting indices for each annotation
        // as keys. This way, we know the positions / indices in the text where
        // we need to display an annotation instead of the plaintext.
        this.annotations.forEach((a) => {
            this.annotationStartingIndices.set(a.startIndex, a);
            a.text = this.text.substring(a.startIndex, a.endIndex);
        });
        let currentIndex = 0;
        let isAnnotationActive = false;
        let annotationActiveUntilIndex = 0;
        let buffer = '';
        this.text.split('').forEach((char) => {
            if (annotationActiveUntilIndex === currentIndex) {
                isAnnotationActive = false;
            }
            if (!this.annotationStartingIndices.has(currentIndex) && !isAnnotationActive) {
                buffer += char;
            }
            else if (this.annotationStartingIndices.has(currentIndex)) {
                if (buffer.length > 0) {
                    this.tokens.push(buffer);
                }
                this.tokens.push(this.annotationStartingIndices.get(currentIndex));
                annotationActiveUntilIndex = this.annotationStartingIndices.get(currentIndex).endIndex;
                buffer = '';
                isAnnotationActive = true;
            }
            currentIndex++;
        });
        if (buffer.length > 0) {
            this.tokens.push(buffer);
        }
    }
}
NgxAnnotateTextComponent.decorators = [
    { type: Component, args: [{
                selector: 'ngx-annotate-text',
                template: "<span *ngFor=\"let token of tokens\">\n\n  <ngx-annotation *ngIf=\"isAnnotation(token)\" [annotation]=\"token\" [removable]=\"removable\"\n    (removeAnnotation)=\"onRemoveAnnotation($event)\" [class]=\"(annotationClass || '')\">\n  </ngx-annotation>\n\n  <span *ngIf=\"!isAnnotation(token)\" class=\"unlabeled\">{{ token }}</span>\n\n</span>",
                styles: [":host(){align-items:flex-start;display:flex;flex-wrap:wrap;white-space:pre-wrap}span.unlabeled{line-height:1.5rem}"]
            },] }
];
NgxAnnotateTextComponent.ctorParameters = () => [
    { type: ElementRef }
];
NgxAnnotateTextComponent.propDecorators = {
    annotations: [{ type: Input }],
    annotationClass: [{ type: Input }],
    removable: [{ type: Input }],
    text: [{ type: Input }],
    annotationsChange: [{ type: Output }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LWFubm90YXRlLXRleHQuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Ii9ob21lL3BoaWwvd29ya3NwYWNlL25neC1hbm5vdGF0ZS10ZXh0LXdvcmtzcGFjZS9wcm9qZWN0cy9uZ3gtYW5ub3RhdGUtdGV4dC9zcmMvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9uZ3gtYW5ub3RhdGUtdGV4dC9uZ3gtYW5ub3RhdGUtdGV4dC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBcUIsTUFBTSxFQUFpQixNQUFNLGVBQWUsQ0FBQztBQUNySCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFRM0QsTUFBTSxPQUFPLHdCQUF3QjtJQTBCbkMsWUFBb0IsVUFBc0I7UUFBdEIsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQXhCMUMsdUVBQXVFO1FBQzlELGdCQUFXLEdBQWlCLEVBQUUsQ0FBQztRQUt4Qzs7O1dBR0c7UUFDTSxjQUFTLEdBQUcsSUFBSSxDQUFDO1FBSzFCLGdGQUFnRjtRQUN0RSxzQkFBaUIsR0FBK0IsSUFBSSxZQUFZLEVBQWdCLENBQUM7UUFFM0YsZ0JBQWdCO1FBQ2hCLFdBQU0sR0FBVSxFQUFFLENBQUM7UUFHWCw4QkFBeUIsR0FBNEIsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUV6QixDQUFDO0lBRS9DLFFBQVE7UUFDTixJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztJQUM3QixDQUFDO0lBRUQsV0FBVyxDQUFDLE9BQXNCO1FBQ2hDLElBQUksYUFBYSxJQUFJLE9BQU8sSUFBSSxNQUFNLElBQUksT0FBTyxFQUFFO1lBQ2pELElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO1NBQzVCO0lBQ0gsQ0FBQztJQUVEOzs7T0FHRztJQUNJLHVCQUF1QjtRQUM1QixJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztRQUUz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QWtCLEdBQUcsS0FBSyxDQUFDO2FBQzVCO1lBRUQsSUFBSSxDQUFDLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsRUFBRTtnQkFDNUUsTUFBTSxJQUFJLElBQUksQ0FBQzthQUNoQjtpQkFBTSxJQUFJLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLEVBQUU7Z0JBQzNELElBQUksTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7b0JBQ3JCLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2lCQUMxQjtnQkFDRCxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMseUJBQXlCLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7Z0JBQ25FLDBCQUEwQixHQUFHLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUMsUUFBUSxDQUFDO2dCQUN2RixNQUFNLEdBQUcsRUFBRSxDQUFDO2dCQUNaLGtCQUFrQixHQUFHLElBQUksQ0FBQzthQUMzQjtZQUVELFlBQVksRUFBRSxDQUFDO1FBQ2pCLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUNyQixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUMxQjtJQUNILENBQUM7OztZQTlIRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLG1CQUFtQjtnQkFDN0Isa1dBQWlEOzthQUVsRDs7O1lBUm1CLFVBQVU7OzswQkFZM0IsS0FBSzs4QkFHTCxLQUFLO3dCQU1MLEtBQUs7bUJBR0wsS0FBSztnQ0FHTCxNQUFNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBFbGVtZW50UmVmLCBFdmVudEVtaXR0ZXIsIElucHV0LCBPbkNoYW5nZXMsIE9uSW5pdCwgT3V0cHV0LCBTaW1wbGVDaGFuZ2VzIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBbm5vdGF0aW9uIH0gZnJvbSAnLi4vLi4vbW9kZWxzL2Fubm90YXRpb24ubW9kZWwnO1xuaW1wb3J0IHsgSVNlbGVjdGlvbiB9IGZyb20gJy4uLy4uL21vZGVscy9zZWxlY3Rpb24ubW9kZWwnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICduZ3gtYW5ub3RhdGUtdGV4dCcsXG4gIHRlbXBsYXRlVXJsOiAnLi9uZ3gtYW5ub3RhdGUtdGV4dC5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL25neC1hbm5vdGF0ZS10ZXh0LmNvbXBvbmVudC5jc3MnXVxufSlcbmV4cG9ydCBjbGFzcyBOZ3hBbm5vdGF0ZVRleHRDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcyB7XG5cbiAgLyoqIFJlcHJlc2VudHMgdGhlIHBhcnRzIG9mIHRoZSBnaXZlbiB0ZXh0IHdoaWNoIHNoYWxsIGJlIGFubm90YXRlZC4gKi9cbiAgQElucHV0KCkgYW5ub3RhdGlvbnM6IEFubm90YXRpb25bXSA9IFtdO1xuXG4gIC8qKiBBbiBvcHRpb25hbCBDU1MgY2xhc3MgYXBwbGllZCB0byBhbGwgZWxlbWVudHMgd2hpY2ggd3JhcCB0aGUgYW5ub3RhdGVkIHBhcnRzIG9mIHRoZSBnaXZlbiB0ZXh0LiAqL1xuICBASW5wdXQoKSBhbm5vdGF0aW9uQ2xhc3M6IHN0cmluZztcblxuICAvKipcbiAgICogRGV0ZXJtaW5lcyB3aGV0aGVyIGFubm90YXRpb25zIHNoYWxsIGhhdmUgYSBzbWFsbCBidXR0b24gaW4gdGhlIHRvcCByaWdodCBjb3JuZXIgc28gdGhhdCB0aGUgdXNlciBjYW5cbiAgICogcmVtb3ZlIGFuIGFubm90YXRpb24uXG4gICAqL1xuICBASW5wdXQoKSByZW1vdmFibGUgPSB0cnVlO1xuXG4gIC8qKiBUaGUgdGV4dCB3aGljaCBzaGFsbCBiZSBkaXNwbGF5ZWQgYW5kIGFubm90YXRlZC4gKi9cbiAgQElucHV0KCkgdGV4dDogc3RyaW5nO1xuXG4gIC8qKiBFbWl0cyB0aGUgbGlzdCBvZiBleGlzdGluZyBhbm5vdGF0aW9ucyBhZnRlciBhbiBlbGVtZW50IGhhcyBiZWVuIHJlbW92ZWQuICovXG4gIEBPdXRwdXQoKSBhbm5vdGF0aW9uc0NoYW5nZTogRXZlbnRFbWl0dGVyPEFubm90YXRpb25bXT4gPSBuZXcgRXZlbnRFbWl0dGVyPEFubm90YXRpb25bXT4oKTtcblxuICAvKiogQGludGVybmFsICovXG4gIHRva2VuczogYW55W10gPSBbXTtcbiAgcHJpdmF0ZSBzZWxlY3Rpb25TdGFydDogbnVtYmVyO1xuICBwcml2YXRlIHNlbGVjdGlvbkVuZDogbnVtYmVyO1xuICBwcml2YXRlIGFubm90YXRpb25TdGFydGluZ0luZGljZXM6IE1hcDxudW1iZXIsIEFubm90YXRpb24+ID0gbmV3IE1hcCgpO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZWxlbWVudFJlZjogRWxlbWVudFJlZikgeyB9XG5cbiAgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgdGhpcy5zcGxpdFRleHRJbnRvVG9rZW5zKCk7XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgaWYgKCdhbm5vdGF0aW9ucycgaW4gY2hhbmdlcyB8fCAndGV4dCcgaW4gY2hhbmdlcykge1xuICAgICAgdGhpcy5zcGxpdFRleHRJbnRvVG9rZW5zKCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIHN0YXJ0IGluZGV4IGFuZCBlbmQgaW5kZXggb2YgdGhlIGN1cnJlbnRseSBzZWxlY3RlZCB0ZXh0IHJhbmdlLiBSZXR1cm5zIGB1bmRlZmluZWRgXG4gICAqIGlmIG5vIHRleHQgaXMgY3VycmVudGx5IHNlbGVjdGVkLlxuICAgKi9cbiAgcHVibGljIGdldEN1cnJlbnRUZXh0U2VsZWN0aW9uKCk6IElTZWxlY3Rpb24ge1xuICAgIHRoaXMudXBkYXRlVGV4dFNlbGVjdGlvbigpO1xuXG4gICAgaWYgKHRoaXMuc2VsZWN0aW9uU3RhcnQgPT09IHVuZGVmaW5lZCB8fCB0aGlzLnNlbGVjdGlvbkVuZCA9PT0gdW5kZWZpbmVkIHx8IHRoaXMuc2VsZWN0aW9uU3RhcnQgPj0gdGhpcy5zZWxlY3Rpb25FbmQpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXJ0SW5kZXg6IHRoaXMuc2VsZWN0aW9uU3RhcnQsXG4gICAgICBlbmRJbmRleDogdGhpcy5zZWxlY3Rpb25FbmQsXG4gICAgfTtcbiAgfVxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgaXNBbm5vdGF0aW9uKGFubm90YXRpb246IEFubm90YXRpb24gfCBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gYW5ub3RhdGlvbiBpbnN0YW5jZW9mIEFubm90YXRpb247XG4gIH1cblxuICAvKiogQGludGVybmFsICovXG4gIG9uUmVtb3ZlQW5ub3RhdGlvbihhbm5vdGF0aW9uOiBBbm5vdGF0aW9uKTogdm9pZCB7XG4gICAgdGhpcy5hbm5vdGF0aW9ucyA9IHRoaXMuYW5ub3RhdGlvbnMuZmlsdGVyKGEgPT4gYSAhPT0gYW5ub3RhdGlvbik7XG4gICAgdGhpcy5hbm5vdGF0aW9uc0NoYW5nZS5lbWl0KHRoaXMuYW5ub3RhdGlvbnMpO1xuICAgIHRoaXMuc3BsaXRUZXh0SW50b1Rva2VucygpO1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVUZXh0U2VsZWN0aW9uKCk6IHZvaWQge1xuICAgIGlmICh3aW5kb3cuZ2V0U2VsZWN0aW9uICYmIHdpbmRvdy5nZXRTZWxlY3Rpb24oKS5yYW5nZUNvdW50ID4gMCkge1xuICAgICAgY29uc3QgcmFuZ2UgPSB3aW5kb3cuZ2V0U2VsZWN0aW9uKCkuZ2V0UmFuZ2VBdCgwKTtcbiAgICAgIGNvbnN0IHByZVNlbGVjdGlvblJhbmdlID0gcmFuZ2UuY2xvbmVSYW5nZSgpO1xuICAgICAgcHJlU2VsZWN0aW9uUmFuZ2Uuc2VsZWN0Tm9kZUNvbnRlbnRzKHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50KTtcbiAgICAgIHByZVNlbGVjdGlvblJhbmdlLnNldEVuZChyYW5nZS5zdGFydENvbnRhaW5lciwgcmFuZ2Uuc3RhcnRPZmZzZXQpO1xuICAgICAgdGhpcy5zZWxlY3Rpb25TdGFydCA9IFsuLi5wcmVTZWxlY3Rpb25SYW5nZS50b1N0cmluZygpXS5sZW5ndGg7XG4gICAgICB0aGlzLnNlbGVjdGlvbkVuZCA9IHRoaXMuc2VsZWN0aW9uU3RhcnQgKyBbLi4ucmFuZ2UudG9TdHJpbmcoKV0ubGVuZ3RoO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnNlbGVjdGlvblN0YXJ0ID0gdW5kZWZpbmVkO1xuICAgICAgdGhpcy5zZWxlY3Rpb25FbmQgPSB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzcGxpdFRleHRJbnRvVG9rZW5zKCk6IHZvaWQge1xuICAgIHRoaXMudG9rZW5zID0gW107XG4gICAgdGhpcy5hbm5vdGF0aW9uU3RhcnRpbmdJbmRpY2VzID0gbmV3IE1hcCgpO1xuXG4gICAgLy8gQ3JlYXRlcyBhIG1hcCB3aGljaCBjb250YWlucyB0aGUgc3RhcnRpbmcgaW5kaWNlcyBmb3IgZWFjaCBhbm5vdGF0aW9uXG4gICAgLy8gYXMga2V5cy4gVGhpcyB3YXksIHdlIGtub3cgdGhlIHBvc2l0aW9ucyAvIGluZGljZXMgaW4gdGhlIHRleHQgd2hlcmVcbiAgICAvLyB3ZSBuZWVkIHRvIGRpc3BsYXkgYW4gYW5ub3RhdGlvbiBpbnN0ZWFkIG9mIHRoZSBwbGFpbnRleHQuXG4gICAgdGhpcy5hbm5vdGF0aW9ucy5mb3JFYWNoKChhOiBBbm5vdGF0aW9uKSA9PiB7XG4gICAgICB0aGlzLmFubm90YXRpb25TdGFydGluZ0luZGljZXMuc2V0KGEuc3RhcnRJbmRleCwgYSk7XG4gICAgICBhLnRleHQgPSB0aGlzLnRleHQuc3Vic3RyaW5nKGEuc3RhcnRJbmRleCwgYS5lbmRJbmRleCk7XG4gICAgfSk7XG5cbiAgICBsZXQgY3VycmVudEluZGV4ID0gMDtcbiAgICBsZXQgaXNBbm5vdGF0aW9uQWN0aXZlID0gZmFsc2U7XG4gICAgbGV0IGFubm90YXRpb25BY3RpdmVVbnRpbEluZGV4ID0gMDtcbiAgICBsZXQgYnVmZmVyID0gJyc7XG5cbiAgICB0aGlzLnRleHQuc3BsaXQoJycpLmZvckVhY2goKGNoYXI6IHN0cmluZykgPT4ge1xuICAgICAgaWYgKGFubm90YXRpb25BY3RpdmVVbnRpbEluZGV4ID09PSBjdXJyZW50SW5kZXgpIHtcbiAgICAgICAgaXNBbm5vdGF0aW9uQWN0aXZlID0gZmFsc2U7XG4gICAgICB9XG5cbiAgICAgIGlmICghdGhpcy5hbm5vdGF0aW9uU3RhcnRpbmdJbmRpY2VzLmhhcyhjdXJyZW50SW5kZXgpICYmICFpc0Fubm90YXRpb25BY3RpdmUpIHtcbiAgICAgICAgYnVmZmVyICs9IGNoYXI7XG4gICAgICB9IGVsc2UgaWYgKHRoaXMuYW5ub3RhdGlvblN0YXJ0aW5nSW5kaWNlcy5oYXMoY3VycmVudEluZGV4KSkge1xuICAgICAgICBpZiAoYnVmZmVyLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICB0aGlzLnRva2Vucy5wdXNoKGJ1ZmZlcik7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy50b2tlbnMucHVzaCh0aGlzLmFubm90YXRpb25TdGFydGluZ0luZGljZXMuZ2V0KGN1cnJlbnRJbmRleCkpO1xuICAgICAgICBhbm5vdGF0aW9uQWN0aXZlVW50aWxJbmRleCA9IHRoaXMuYW5ub3RhdGlvblN0YXJ0aW5nSW5kaWNlcy5nZXQoY3VycmVudEluZGV4KS5lbmRJbmRleDtcbiAgICAgICAgYnVmZmVyID0gJyc7XG4gICAgICAgIGlzQW5ub3RhdGlvbkFjdGl2ZSA9IHRydWU7XG4gICAgICB9XG5cbiAgICAgIGN1cnJlbnRJbmRleCsrO1xuICAgIH0pO1xuXG4gICAgaWYgKGJ1ZmZlci5sZW5ndGggPiAwKSB7XG4gICAgICB0aGlzLnRva2Vucy5wdXNoKGJ1ZmZlcik7XG4gICAgfVxuICB9XG5cbn1cbiJdfQ==